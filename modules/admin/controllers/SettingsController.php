<?php
namespace app\modules\admin\controllers;

use app\models\Employee;
use app\models\Rate;
use Yii;
use yii\filters\AccessControl;
use yii\web\Controller;
use yii\filters\VerbFilter;
use app\models\LoginForm;
use app\models\ContactForm;
use yii\web\UploadedFile;

class SettingsController extends Controller
{
    //public $layout = 'basic';
    public $defaultAction = 'index';

    public function behaviors()
    {
        return [
            'access' => [
                'class' => AccessControl::className(),
                'rules' => [
                    [
                        'allow' => true,
                        'roles' => ['@'],
                    ],
                ],
            ],
            'verbs' => [
                'class' => VerbFilter::className(),
                'actions' => [
                    'logout' => ['post'],
                ],
            ],
        ];
    }

    public function actions()
    {
        return [
            'error' => [
                'class' => 'yii\web\ErrorAction',
            ],
            'captcha' => [
                'class' => 'yii\captcha\CaptchaAction',
                'fixedVerifyCode' => YII_ENV_TEST ? 'testme' : null,
            ],
        ];
    }

    public function actionIndex()
    {
        $rate = Rate::find()->all();
        //vd($rate);
        $employees = [];
        $dates = [];
        $tableArr = [];
        foreach ($rate as $item){
            if(is_null($tableArr[$item->employee_id][$item->created_time]))$tableArr[$item->employee_id][$item->created_time] = [];
            $tableArr[$item->employee_id][$item->created_time] = $item->rate;
            if(!in_array($item->employee_id, $employees)){
                array_push($employees, $item->employee_id);
            }
            if(!in_array($item->created_time, $dates)){
                array_push($dates, $item->created_time);
            }
        }

        return $this->render('index', [
            'rate' => $rate,
            'employees' => $employees,
            'dates' => $dates,
            'tableArr' => $tableArr,
        ]);

    }

    public function actionSpreadSheet(){
        return $this->render('sheet', [
            'data' => 1,
        ]);
    }

    public function actionSetData(){
        //$post = Yii::$app->request->post();
        //print_r($post['sheet']);
        $post = '[["","user_id","employee_id","Логин","07.02.2018","08.02.2018","09.02.2018","10.02.2018","11.02.2018","12.02.2018","13.02.2018","14.02.2018","15.02.2018","16.02.2018","","","27.02.2018","28.02.2018","01.03.2018","02.03.2018","03.03.2018","04.03.2018","05.03.2018","06.03.2018","07.03.2018","12.03.2018","13.03.2018","14.03.2018","15.03.2018","16.03.2018","19.03.2018","20.03.2018","21.03.2018","22.03.2018","23.03.2018","26.03.2018","27.03.2018","28.03.2018","29.03.2018","30.03.2018","02.04.2018","03.04.2018","04.04.2018","05.04.2018","06.04.2018","09.04.2018","10.04.2018","11.04.2018","12.04.2018","13.04.2018"],["Марк ","22","19","mirkocrocop3000","300","330","360","","","320","300","290","300","330","","","350","290","330","360","","","380","400","360","340","380","360","400","400","320","320","300","340","320","380","380","320","290","290","330","290","290","290","330","320","300"],["Алекс ","33","31","aigerasimov20","340","360","400","","","360","300","300","340","390","","","380","340","320","360","","","380","450","360","360","300","390","440","420","340","360","300","340","360","300","380","300","330","320","390","350","360","360","390","300","290"],["Линь ","31","29","linhle","380","280","290","","","370","290","250","280","330","","","320","300","300","380","","","300","300","380","300","380","390","300","300","300","320","300","290","320","380","300","300","310","300","300","330","310","310","300","300","300"],["Лиза ","37","35","Liza","290","350","330","","","290","280","260","300","300","","","290","400","320","380","","","370","280","380","380","290","300","280","290","290","350","300","290","350","290","370","280","380","380","340","330","330","320","340","280","290"],["Даша ","38","36","etterwin","320","320","300","","","280","290","380","390","300","","","400","400","340","340","","","380","300","340","300","390","300","280","290","290","350","300","300","350","390","380","300","340","300","340","360","370","350","340","300","300"],["Грахова ","41","39","Alex_G","340","290","270","","","280","290","290","320","300","","","320","320","320","340","","","350","340","340","340","320","340","320","350","300","300","300","300","310","320","350","340","340","340","300","290","300","320","300","340","290"],["Марина ","32","30","marinasvechnikova1910","340","370","360","","","370","320","370","340","390","","","360","350","350","380","","","390","310","380","300","340","380","400","380","300","360","300","380","360","340","390","310","330","300","300","360","380","360","300","310","340"],["Антон","30","28","T0nIk","","","","","","","","","","","","","","330","320","300","","","290","290","300","300","300","290","280","300","290","290","300","290","290","300","290","290","300","300","290","320","300","290","290","250","250"],["Влад","42","40","exampllee","","","","","","","","","","","","","","","","","","","","","","","","","","","300","330","300","320","330","390","390","340","320","390","340","340","370","370","340","340","300"],["Люба","40","38","ertanfighter","300","310","290","","","280","270","290","280","260","","","280","250","290","270","","","250","280","250","270","300","280","270","300","270","290","260","280","270","260","280","260","290","280","0","0","0"],["Саша ","39","37","larsen_aa","300","310","290","","","270","270","290","280","260","","","280","250","290","270","","","250","280","250","270","300","280","270","300","270","290","260","280","270","260","280","260","290","280","270","260","280"],["Женя ","44","42","EvgeniayTudachkova","260","290","310","","","280","290","310","320","350","","","330","230","280","280","","","300","350","320","280","350","350","360","370","340","300","350","290","250","330","280","250","240","240","250","260","250"],["Леня","27","24","Artua","250","290","300","","","270","270","300","270","290","","","300","250","270","290","","","295","310","300","270","290","295","290","300","360","360","340","300","300","290","280","250","250","250","260","250","260"],["Саня","25","22","Kuro182","","","","","","","","","","","","","","","","","","","","","","","330","335","330","350","340","360","350","340","360","300","290","300","310","300","330","300","310"],["Вова ","35","33","vova","290","260","310","","","200","270","280","290","310","","","0","0","0","0","","","0","0","0","280","280","280","250","380","350","330","380","340","330","220","370","380","390","380","350","360","370","350","360","320"],["Рус ","24","21","pror25","0","270","310","","","270","260","280","290","290","","","300","270","270","280","","","280","290","320","270","280","300","340","0","340","330","200","0","300","150","390","350","360","350","300","320","390","330","320","0"],["Артем Б.","21","18","papets2008","280","280","310","","","290","270","290","310","290","","","320","280","280","290","","","270","330","300","0","0","280","240","370","350","370","390","360","390","200","370","410","200","0","370","390","360","350","350","300"],["Саша ","28","25","Tobifer","240","250","280","","","260","250","280","280","280","","","280","270","270","270","","","290","280","280","280","290","280","220","330","370","380","370","380","360","250","340","380","380","360","370","380","360","360","380","340"],["Дима","36","34","damkilll","","","","","","","","","","","","","","","","","","","","","","","260","220","220","320","0","310","320","330","320","220","320","340","330","320","290","290","0","0","0","0"],["Рома ","26","23","Roma","250","270","300","","","200","200","250","250","250","","","250","290","280","230","","","250","280","280","250","200","320","350","310","340","340","380","370","370","280","270","260","330","380","390","390","320","250","280","290"],["Миша ","23","20","iksmikhail","300","300","310","","","270","250","290","280","290","","","280","330","280","290","","","290","330","300","300","400","280","270","330","340","370","400","370","390","300","350","290","300","310","320","320","320","250","280","330"],["Паша ","20","17","pavel","310","300","330","","","300","270","260","290","310","","","310","330","300","300","","","290","330","320","350","300","300","400","380","400","400","400","380","390","200","360","380","380","400","400","370","390","280","360","380"],["Эмиль ","43","41","emi","250","270","320","","","310","270","280","280","300","","","300","350","260","290","","","270","200","290","300","350","230","320","320","440","400","0","370","340","350","370","410","360","0","420","390","300","300","250","350"],["Леда ","34","32","leda_imnida","290","290","320","","","300","320","300","280","290","","","270","290","310","290","","","260","300","320","300","300","260","290","270","300","340","310","300","270","280","320","300","300","280","350","320","320","300","320","310"],["Ксюша ","45","43","VokuevaKsenia","250","250","280","","","250","270","260","250","260","","","270","270","250","260","","","260","250","320","250","0","0","0","0","0","0","0","0","0","270","270","270","270","270","270","270","270","250","0","250"],["Аня ","","","","0","0","0","","","0","300","300","280","290","","","250","290","330","280","","","260","260","320","320","300","260","270","260","270","300","270","290","250"]]';
        //if(isset($post['sheet'])){
        $sheetArr = json_decode($post/*['sheet']*/);
        foreach ($sheetArr as $r => $row){
            if($r == 0 ){
                foreach($row as $c => $col){
                    if($c<4) {
                        $dateArr[] = '';
                    }else{
                        $dateArr[] = $date = date('Y-m-d H:i:s', strtotime($col));
                    }

                }

            }elseif($r > 0 ){
                $employee_id = 0;
                foreach($row as $c => $col){
                    if($c == 2)$employee_id = $col;
                    if($employee_id == 0)continue;
                    $rate = Rate::find()->where(
                        [
                            'employee_id' => $employee_id,
                            'task_id' => null,
                            'created_time' => $dateArr[$c],
                        ]
                    )->select('rate')->one();

                    //if($col == '')continue;
                    if(is_null($rate)){
                        $rate = new Rate();
                        $rate->rate = $col;
                        $rate->employee_id = $employee_id;
                        $rate->task_id = null;
                        $rate->created_time = $dateArr[$c];
                        if($rate->rate == '' || $rate->created_time == '')continue;
                        if(!$rate->save()){
                            vd($rate->errors);
                        }
                        //vd($rate, false);
                    }elseif($rate->rate != $col){
                        //echo $dateArr[$c].' '.$rate->rate.' '.$col.' '.$employee_id."<br>";

                        /*$rate = new Rate();
                        $rate->rate = $col;
                        $rate->employee_id = $employee_id;
                        $rate->task_id = null;
                        $rate->created_time = $dateArr[$c];
                        if($rate->rate == '')continue;
                        vd($rate, false);*/

                    }
                    //vd($rate, false);
                    //if($rate->rate)

                    //vd($rate->rate, false);
                    //echo $dateArr[$c].' '.$col.' '.$employee_id."<br>";

                    //echo $col."<br>";
                    //if($c<4 || $col == '')continue;
                    //$dateArr[] = $date = date('Y-m-d H:i:s', strtotime($col));
                }
                //vd($dateArr);
            }


        }
        //vd($sheetArr);
        //}
    }

    public function actionChart(){
        $rate = Rate::find()->all();
        //vd($rate);
        $employees = [];
        $dates = [];
        $tableArr = [];
        foreach ($rate as $item){
            if(is_null($tableArr[$item->employee_id][$item->created_time]))$tableArr[$item->employee_id][$item->created_time] = [];
            $tableArr[$item->employee_id][$item->created_time] = $item->rate;
            if(!in_array($item->employee_id, $employees)){
                array_push($employees, $item->employee_id);
            }
            if(!in_array($item->created_time, $dates)){
                array_push($dates, $item->created_time);
            }
        }

        return $this->render('chart', [
            'rate' => $rate,
            'employees' => $employees,
            'dates' => $dates,
            'tableArr' => $tableArr,
        ]);
    }

    public function actionCreate(){
        $employees = Employee::find()->all();
        return $this->render('create', [
            'employees' => $employees,
        ]);
    }
}